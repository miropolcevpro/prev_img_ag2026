<div id="paverConf2026" class="paverConf2026"
  data-cdn="https://cdn.jsdelivr.net/gh/miropolcevpro/prev_img_ag2026@main/">

  <div class="paverConf2026__head">
    <div class="paverConf2026__title">Конфигуратор плитки</div>
    <div class="paverConf2026__subtitle">Форма → Технология → Цвет → Толщина → Площадь → Итог</div>
  </div>

  <div class="pcLayout">
    <div class="pcLayout__left">

      <div class="paverConf2026__step">
        <div class="paverConf2026__stepTitle">1) Форма</div>
        <div class="paverConf2026__grid paverConf2026__grid--forms" data-role="forms"></div>
      </div>

      <div class="paverConf2026__step">
        <div class="paverConf2026__stepTitle">2) Технология</div>
        <div class="paverConf2026__tabs" data-role="techTabs"></div>
        <div class="paverConf2026__techHint" data-role="techHint"></div>
      </div>

      <div class="paverConf2026__step">
        <div class="paverConf2026__stepTitle"> 3) Цвет (демонстрация палитры представлена на рандомных формах)</div>
        <div class="paverConf2026__picked" data-role="picked"></div>
        <div class="paverConf2026__grid paverConf2026__grid--colors" data-role="colors"></div>
      </div>
<div class="paverConf2026__status" data-role="status">Загрузка…</div>
    </div>

    <!-- RIGHT PANEL -->
    <aside class="pcLayout__right">
      <div class="pcCalc">
        <div class="pcCalc__title">Расчёт</div>

        <div class="pcCalc__kv">
          <div class="pcCalc__row"><span>Цена за 1 м²</span><b data-role="unitPrice">—</b></div>
        </div>

        <div class="pcCalc__th" data-role="thicknessWrap">
          <label class="pcCalc__label">Толщина</label>
          <div class="paverConf2026__tabs pcCalc__thTabs" data-role="thicknessTabs"></div>
          <b data-role="thLabel" style="display:none">—</b>
        </div>

        <div class="pcCalc__input">
          <label class="pcCalc__label">Площадь, м²</label>
          <input class="pcCalc__field" data-role="qty" type="number" min="0" step="0.1" value="10" />
          <div class="pcCalc__hint">Расчёт кратно поддону.</div>
        </div>

        <div class="pcCalc__total">
          <div class="pcCalc__row pcCalc__row--big"><span>Итого</span><b data-role="totalPrice">—</b></div>
          <div class="pcCalc__note">* Цена ориентировочная и не является публичной офертой. Итоговая стоимость уточняется менеджером.</div>
        </div>

        <button type="button" class="pcCalc__moreBtn" data-role="moreBtn" aria-expanded="false">
          Дополнительная информация
          <span class="pcCalc__chev" aria-hidden="true">▾</span>
        </button>

        <div class="pcCalc__more" data-role="morePanel" hidden>
          <div class="pcCalc__moreTitle">Технические характеристики и отгрузка</div>
          <div class="pcCalc__kv">
            <div class="pcCalc__row"><span>м² в 1 поддоне</span><b data-role="m2Pallet">—</b></div>
            <div class="pcCalc__row"><span>Вес 1 поддона</span><b data-role="wPallet">—</b></div>
            <div class="pcCalc__row"><span>Полных поддонов</span><b data-role="pallets">—</b></div>
            <div class="pcCalc__row"><span>Отгрузка, м²</span><b data-role="shipM2">—</b></div>
            <div class="pcCalc__row"><span>Перебор, м²</span><b data-role="overM2">—</b></div>
            <div class="pcCalc__row"><span>Вес общий, кг</span><b data-role="shipW">—</b></div>
          </div>
          <div class="pcCalc__note">Поддоны считаются с округлением вверх (кратно поддону).</div>
        </div>

        <div class="pcCalc__formTitle">Отправить заявку</div>
        <form id="paverLeadForm" class="pcForm">
          <div class="pcForm__grid">
            <input name="firstname" class="pcForm__field" placeholder="Имя" required>
            <input name="lastname"  class="pcForm__field" placeholder="Фамилия" required>
            <input name="phone" class="pcForm__field" placeholder="Телефон" required>
            <input name="city" class="pcForm__field" placeholder="Город">
          </div>
          <textarea name="comment" class="pcForm__area" placeholder="Комментарий"></textarea>
          
          <!-- Автозаполнение параметров заказа (скрытые поля) -->
          <input type="hidden" name="order_form">
          <input type="hidden" name="order_technology">
          <input type="hidden" name="order_color">
          <input type="hidden" name="order_thickness_mm">
          <input type="hidden" name="order_area_m2">
          <input type="hidden" name="order_m2_per_pallet">
          <input type="hidden" name="order_pallets">
          <input type="hidden" name="order_ship_m2">
          <input type="hidden" name="order_over_m2">
          <input type="hidden" name="order_weight_kg">
          <input type="hidden" name="order_unit_price">
          <input type="hidden" name="order_total_price">

          <button type="submit" class="pcForm__btn">Отправить</button>
          <div class="pcForm__sub">Мы свяжемся с вами для уточнения заказа.</div>
        </form>
      </div>
    </aside>
  </div>
</div>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;800;900&display=swap');
  :root{
    --pcB: rgba(0,0,0,.12);
    --pcB2: rgba(0,0,0,.18);
    --pcT: rgba(0,0,0,.92);
    --pcM: rgba(0,0,0,.62);
    --pcGreen: #1f6b3a;
    --pcS1: 0 5px 12px rgba(0,0,0,.06);
    --pcS2: 0 9px 20px rgba(0,0,0,.10);
    --pcR: 14px;
  }
  .paverConf2026{
    font-family:'Roboto', system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    border:1px solid var(--pcB);
    border-radius: var(--pcR);
    padding: 12px;
    max-width: 1220px;
    background: #fff;
  }
  .paverConf2026__head{display:flex;flex-direction:column;gap:2px;margin-bottom:10px}
  .paverConf2026__title{font-size:26px;font-weight:900;line-height:1.05;color:var(--pcT)}
  .paverConf2026__subtitle{font-size:13.5px;line-height:1.2;color:var(--pcM)}

  .pcLayout{
    display:grid;
    grid-template-columns: minmax(0, 1fr) 360px;
    gap: 14px;
    align-items:start;
  }
  .pcLayout__right{position: sticky; top: 12px;}
  @media (max-width: 760px){
    .pcLayout{grid-template-columns: 1fr;}
    .pcLayout__right{position: static;}
  }

  .paverConf2026__step{margin-top:10px}
  .paverConf2026__stepTitle{font-size:19px;font-weight:900;color:var(--pcT);margin-bottom:6px}
  .paverConf2026__grid{display:grid;gap:9px}
  .paverConf2026__grid--forms,
  .paverConf2026__grid--colors{grid-template-columns: repeat(6, minmax(0, 1fr));}

  .paverConf2026__card{
    border:1px solid var(--pcB);
    border-radius: 12px;
    background:#fff;
    overflow:hidden;
    cursor:pointer;
    display:flex;
    flex-direction:column;
    box-shadow: var(--pcS1);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .paverConf2026__card:hover{transform: translateY(-1px); box-shadow: var(--pcS2);}
  .paverConf2026__card.is-active{outline:3px solid rgba(0,0,0,.82); outline-offset:2px;}
  .paverConf2026__img{
    background: linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.00));
    display:flex; align-items:center; justify-content:center;
    padding: 4px;
  }
  .paverConf2026__grid--forms .paverConf2026__img{aspect-ratio: 16 / 11;}
  .paverConf2026__grid--colors .paverConf2026__img{aspect-ratio: 1 / 1;}
  .paverConf2026__img img{width:100%;height:100%;object-fit:contain;display:block}
  .paverConf2026__name{
    padding: 4px 8px 6px;
    font-size: 13.3px;
    font-weight: 800;
    line-height: 1.12;
    color: var(--pcT);
  }
  .paverConf2026__grid--colors .paverConf2026__name{font-size:12.6px;font-weight:700}

  .paverConf2026__tabs{display:flex;flex-wrap:wrap;gap:8px}
  .paverConf2026__tab{
    border:1px solid var(--pcB2);
    border-radius: 999px;
    padding: 9px 12px;
    font-size: 14px;
    font-weight: 800;
    background:#fff;
    cursor:pointer;
    line-height:1;
    transition: background .12s ease, color .12s ease, border-color .12s ease, transform .12s ease;
  }
  .paverConf2026__tab:hover{transform:translateY(-1px)}
  .paverConf2026__tab.is-active{background:#111;color:#fff;border-color:#111}
  .paverConf2026__techHint{margin-top:6px;font-size:12.8px;color:var(--pcM);line-height:1.25}
  .paverConf2026__picked{margin: 2px 0 8px;font-size: 13.5px;line-height: 1.2;color: var(--pcM)}
  .paverConf2026__picked b{color:var(--pcT)}
  .paverConf2026__status{margin-top:10px;font-size:12.8px;color:var(--pcM)}

  @media (max-width: 1200px){
    .paverConf2026__grid--forms,
    .paverConf2026__grid--colors{grid-template-columns: repeat(4, minmax(0, 1fr));}
  }
  @media (max-width: 820px){
    .paverConf2026__grid--forms,
    .paverConf2026__grid--colors{grid-template-columns: repeat(3, minmax(0, 1fr));}
  }
  @media (max-width: 520px){
    .paverConf2026{padding:10px}
    .paverConf2026__title{font-size:22px}
    .paverConf2026__stepTitle{font-size:17px}
    .paverConf2026__grid--forms,
    .paverConf2026__grid--colors{grid-template-columns: repeat(2, minmax(0, 1fr));}
  }

  /* Right panel */
  .pcCalc{border:1px solid var(--pcB);border-radius:14px;padding:12px;background:#fff;}
  .pcCalc__title{font-size:18px;font-weight:900;margin-bottom:10px;color:var(--pcT)}
  .pcCalc__kv{display:flex;flex-direction:column;gap:7px;margin:10px 0}
  .pcCalc__row{display:flex;justify-content:space-between;gap:10px;font-size:13.5px;color:var(--pcT)}
  .pcCalc__row b{font-weight:900}
  .pcCalc__row--big{font-size:16px}
  .pcCalc__note{margin-top:8px;font-size:12.6px;color:var(--pcM);line-height:1.25}

  .pcCalc__input{margin:10px 0;}
  .pcCalc__label{display:block;font-size:13px;font-weight:900;margin-bottom:6px;}
  .pcCalc__field{width:100%;height:42px;border:1px solid rgba(0,0,0,.18);border-radius:12px;padding:0 12px;font-size:16px;font-family:inherit;}

  .pcCalc__moreBtn{
    width:100%;
    margin-top:10px;
    height:42px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.18);
    background:#fff;
    font-weight:900;
    font-size:13.5px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
  }
  .pcCalc__chev{opacity:.7; transform: translateY(-1px);}
  .pcCalc__more{margin-top:10px; padding-top:10px; border-top:1px solid rgba(0,0,0,.10);}
  .pcCalc__moreTitle{font-size:13.5px; font-weight:900; margin-bottom:8px;}

  .pcCalc__formTitle{margin-top:14px;font-size:16px;font-weight:900;}
  .pcForm{margin-top:10px; display:flex; flex-direction:column; gap:10px}
  .pcForm__grid{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  @media (max-width: 520px){ .pcForm__grid{grid-template-columns: 1fr;} }
  .pcForm__field, .pcForm__area{border:1px solid rgba(0,0,0,.18);border-radius:12px;padding:10px 12px;font-size:14px;font-family:inherit;}
  .pcForm__area{min-height:90px; resize:vertical}
  .pcForm__btn{height:44px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:900;font-size:14px;cursor:pointer;}
  .pcForm__sub{font-size:12.5px;opacity:.7;line-height:1.2}




  /* --- UI tweak: add vertical breathing room between texts --- */
  .paverConf2026__stepTitle{margin-bottom:14px;}
  .pcHint{margin-top:10px; margin-bottom:14px; line-height:1.35;}
  .pcSelected{margin-top:10px; margin-bottom:10px; line-height:1.35;}

  /* --- UI FIX: contact form inputs stay inside frame --- */
  .pcForm__grid > *{min-width:0;}
  .pcForm__field, .pcForm__area{width:100%; max-width:100%; min-width:0;}

  /* --- FIXES: box sizing + calc panel thickness + spacing --- */
  #paverConf2026, #paverConf2026 *{box-sizing:border-box;}
  .pcCalc__hint{margin-top:8px;margin-bottom:14px;font-size:12.8px;color:var(--pcM);line-height:1.25;}
  .pcCalc__row--big b{color:var(--pcGreen); font-size:20px;}
  .pcCalc__th{margin:10px 0;}
  .pcCalc__thTabs{margin-top:6px;}
  .pcCalc__th[data-hidden="1"]{display:none;}
</style>

<script>
(async function(){
  const root = document.getElementById('paverConf2026');
  const CDN0 = (root.dataset.cdn || '').trim().replace(/\/?$/,'/');

  const FORMS_JSON  = 'forms.json';
  const PRICE_JSON  = 'price_catalog.json';
  const PALS = {
    stonemix: 'palettes_stonemix.json',
    colormix: 'palettes_colormix.json',
    mono:     'palettes_mono.json'
  };

  // ===== Inline fallback data (so configurator works even if CDN is cached/broken) =====
  const INLINE_DATA = {
    forms: [{"id":"antika","name":"Антика","preview":"forms/antika/preview.webp","image":"forms/antika/image.webp"},{"id":"bruschatka","name":"Брусчатка (80мм)","preview":"forms/bruschatka/preview.webp","image":"forms/bruschatka/image.webp"},{"id":"gazonnaya_reshetka","name":"Газонная Решетка","preview":"forms/gazonnaya_reshetka/preview.webp","image":"forms/gazonnaya_reshetka/image.webp"},{"id":"klassika","name":"Классика","preview":"forms/klassika/preview.webp","image":"forms/klassika/image.webp"},{"id":"megapolis","name":"Мегаполис","preview":"forms/megapolis/preview.webp","image":"forms/megapolis/image.webp"},{"id":"novyy_gorod","name":"Новый город","preview":"forms/novyy_gorod/preview.webp","image":"forms/novyy_gorod/image.webp"},{"id":"paladio","name":"Паладио","preview":"forms/paladio/preview.webp","image":"forms/paladio/image.webp"},{"id":"poligonal","name":"Полигональ","preview":"forms/poligonal/preview.webp","image":"forms/poligonal/image.webp"},{"id":"promenad_i","name":"Променад I (40–60мм)","preview":"forms/promenad_i/preview.webp","image":"forms/promenad_i/image.webp"},{"id":"promenad_ii","name":"Променад  II","preview":"forms/promenad_ii/preview.webp","image":"forms/promenad_ii/image.webp"},{"id":"rigel","name":"Ригель","preview":"forms/rigel/preview.webp","image":"forms/rigel/image.webp"},{"id":"staryy_gorod","name":"Старый Город","preview":"forms/staryy_gorod/preview.webp","image":"forms/staryy_gorod/image.webp"}],
    price: {"meta":{"source":"РЕКОМЕНДОВАННЫЕ РОЗНИЧНЫЕ ЦЕНЫ ЗАВОДА «АКТИВ ГРУПП»","vat_percent":22,"effective_from":"2026-01-01","unit_note":"цены указаны без учета доставки и тары; продажа от 1 поддона (плитка) / от 1 поддона (камень бортовой)"},"pavers":{"unit":"m2","items":[{"id":"антика","name":"Антика","thickness":[{"mm":60,"prices":{"grey":1062.4515,"mono_color1":1238.3406,"mono_color2":1371.5283,"colormix_2":1688.7387,"colormix_3":1836.1602,"colormix_fakt":1892.0787,"stonemix":2624.1027},"packaging":{"pcs_per_pallet":"192\n240\n240\n336\n240","pcs_per_m2":"97,50\n107,40\n120,90\n136,70\n159,50 ","m2_per_pallet":10.2,"pallet_weight_kg":1400.0}}]},{"id":"брусчатка","name":"Брусчатка","thickness":[{"mm":60,"prices":{"grey":970.9485,"mono_color1":1168.1883,"mono_color2":1273.9251,"colormix_2":1576.9017,"colormix_3":1744.6572,"colormix_fakt":1780.2417,"stonemix":2336.3766},"packaging":{"pcs_per_pallet":576,"pcs_per_m2":50,"m2_per_pallet":11.52,"pallet_weight_kg":1560.0}},{"mm":80,"prices":{"grey":1188.5223,"mono_color1":1435.5804,"mono_color2":1647.054,"colormix_2":2054.7507,"colormix_3":2230.6398,"colormix_fakt":2286.5583,"stonemix":3046.0332},"packaging":{"pcs_per_pallet":432,"pcs_per_m2":50,"m2_per_pallet":8.64,"pallet_weight_kg":1610.0}}]},{"id":"газонная_решетка","name":"Газонная решетка","thickness":[{"mm":80,"prices":{"grey":1315.6098,"mono_color1":1554.5343,"mono_color2":"по запросу","colormix_2":"по запросу","colormix_3":"по запросу","colormix_fakt":"по запросу","stonemix":"-"},"packaging":{"pcs_per_pallet":40,"pcs_per_m2":4.17,"m2_per_pallet":9.6,"pallet_weight_kg":1070.0}}]},{"id":"классика","name":"Классика","thickness":[{"mm":60,"prices":{"grey":978.0654,"mono_color1":1168.1883,"mono_color2":1294.2591,"colormix_2":1547.4174,"colormix_3":1660.2711,"colormix_fakt":1808.7093,"stonemix":2392.2951},"packaging":{"pcs_per_pallet":840,"pcs_per_m2":75.06,"m2_per_pallet":11.2,"pallet_weight_kg":1430.0}}]},{"id":"мегаполис","name":"Мегаполис","thickness":[{"mm":80,"prices":{"grey":1554.5343,"mono_color1":1681.6218,"mono_color2":1885.9785,"colormix_2":2413.6458,"colormix_3":2561.0673,"colormix_fakt":2645.4534,"stonemix":3349.0098},"packaging":{"pcs_per_pallet":40,"pcs_per_m2":5.555555555555556,"m2_per_pallet":7.2,"pallet_weight_kg":1300.0}}]},{"id":"новый_город","name":"Новый город","thickness":[{"mm":40,"prices":{"grey":766.5918,"mono_color1":900.7962,"mono_color2":992.2992,"colormix_2":1210.8897,"colormix_3":1301.376,"colormix_fakt":1414.2297,"stonemix":1730.4234},"packaging":{"pcs_per_pallet":"160\n160\n160","pcs_per_m2":"39,06\n31,25\n26,04","m2_per_pallet":15.36,"pallet_weight_kg":1475.0}},{"mm":60,"prices":{"grey":970.9485,"mono_color1":1168.1883,"mono_color2":1273.9251,"colormix_2":1576.9017,"colormix_3":1744.6572,"colormix_fakt":1780.2417,"stonemix":2336.3766},"packaging":{"pcs_per_pallet":"120\n120\n120","pcs_per_m2":"39,06\n31,25\n26,04","m2_per_pallet":11.52,"pallet_weight_kg":1560.0}},{"mm":80,"prices":{"grey":1188.5223,"mono_color1":1435.5804,"mono_color2":1647.054,"colormix_2":2054.7507,"colormix_3":2230.6398,"colormix_fakt":2286.5583,"stonemix":3046.0332},"packaging":{"pcs_per_pallet":"90\n90\n90                  ","pcs_per_m2":"39.06\n31.25\n26.04","m2_per_pallet":8.64,"pallet_weight_kg":1610.0}}]},{"id":"палладио","name":"Палладио","thickness":[{"mm":80,"prices":{"grey":1188.5223,"mono_color1":1435.5804,"mono_color2":1647.054,"colormix_2":2054.7507,"colormix_3":2230.6398,"colormix_fakt":2286.5583,"stonemix":3046.0332},"packaging":{"pcs_per_pallet":108,"pcs_per_m2":12.5,"m2_per_pallet":8.64,"pallet_weight_kg":1610.0}}]},{"id":"полигональ","name":"Полигональ","thickness":[{"mm":60,"prices":{"grey":1464.048,"mono_color1":1600.2858,"mono_color2":1741.6071,"colormix_2":2257.074,"colormix_3":2400.4287,"colormix_fakt":2503.1154,"stonemix":3037.8996},"packaging":{"pcs_per_pallet":"12\n12\n12\n12\n12\n12","pcs_per_m2":"9,92\n10,03\n17,35\n11,50\n11,42\n8,23","m2_per_pallet":6.65,"pallet_weight_kg":930.0}}]},{"id":"променад_i","name":"Променад I","thickness":[{"mm":40,"prices":{"grey":766.5918,"mono_color1":900.7962,"mono_color2":992.2992,"colormix_2":1210.8897,"colormix_3":1301.376,"colormix_fakt":1414.2297,"stonemix":1730.4234},"packaging":{"pcs_per_pallet":768,"pcs_per_m2":50,"m2_per_pallet":15.36,"pallet_weight_kg":1475.0}},{"mm":60,"prices":{"grey":970.9485,"mono_color1":1168.1883,"mono_color2":1273.9251,"colormix_2":1576.9017,"colormix_3":1744.6572,"colormix_fakt":1780.2417,"stonemix":2336.3766},"packaging":{"pcs_per_pallet":576,"pcs_per_m2":50,"m2_per_pallet":11.52,"pallet_weight_kg":1560.0}}]},{"id":"променад_ii","name":"Променад II","thickness":[{"mm":40,"prices":{"grey":766.5918,"mono_color1":900.7962,"mono_color2":992.2992,"colormix_2":1210.8897,"colormix_3":1301.376,"colormix_fakt":1414.2297,"stonemix":1730.4234},"packaging":{"pcs_per_pallet":"168\n112","pcs_per_m2":"25\n16,7","m2_per_pallet":13.44,"pallet_weight_kg":1290.0}},{"mm":60,"prices":{"grey":970.9485,"mono_color1":1168.1883,"mono_color2":1273.9251,"colormix_2":1576.9017,"colormix_3":1744.6572,"colormix_fakt":1780.2417,"stonemix":2336.3766},"packaging":{"pcs_per_pallet":"144\n96","pcs_per_m2":"25\n16,7","m2_per_pallet":11.52,"pallet_weight_kg":1560.0}}]},{"id":"ригель","name":"Ригель","thickness":[{"mm":60,"prices":{"grey":970.9485,"mono_color1":1168.1883,"mono_color2":1273.9251,"colormix_2":1576.9017,"colormix_3":1744.6572,"colormix_fakt":1780.2417,"stonemix":2336.3766},"packaging":{"pcs_per_pallet":384,"pcs_per_m2":33.33,"m2_per_pallet":11.52,"pallet_weight_kg":1560.0}}]},{"id":"старый_город","name":"Старый город","thickness":[{"mm":60,"prices":{"grey":1005.5163,"mono_color1":1203.7728,"mono_color2":1322.7267,"colormix_2":1611.4695,"colormix_3":1695.8556,"colormix_fakt":1850.394,"stonemix":2462.4474},"packaging":{"pcs_per_pallet":"180\n252\n252","pcs_per_m2":"138,89\n69,44\n46,29","m2_per_pallet":10.37,"pallet_weight_kg":1370.0}}]}]},"curbstone":{"unit":"piece","items":[{"id":"бр_100.20.8_1000х200х80","name":"БР 100.20.8 1000х200х80","width_mm":80,"prices":{"grey":331.4442,"mono_color1":471.7488,"mono_color2":485.9826,"colormix_2":527.6673,"colormix_3":556.1349,"colormix_fakt":583.5858,"stonemix":619.1703},"packaging":{"pcs_per_pallet":36,"pallet_weight_kg":1340.0}},{"id":"бр_100.30.15_1000х300х150","name":"БР 100.30.15 1000х300х150","width_mm":150,"prices":{"grey":752.358,"mono_color1":"по запросу","mono_color2":"по запросу","colormix_2":"по запросу","colormix_3":"по запросу","colormix_fakt":"-","stonemix":"-"},"packaging":{"pcs_per_pallet":15,"pallet_weight_kg":1500.0}},{"id":"бр_100.30.18_1000х300х180","name":"БР 100.30.18 1000х300х180","width_mm":180,"prices":{"grey":844.8777,"mono_color1":"по запросу","mono_color2":"по запросу","colormix_2":"по запросу","colormix_3":"по запросу","colormix_fakt":"-","stonemix":"-"},"packaging":{"pcs_per_pallet":12,"pallet_weight_kg":1450.0}}]},"pricing_columns":{"grey":"Серый","mono_color1":"Цвет 1*","mono_color2":"Цвет 2*","colormix_2":"Колормикс (2 цвета)","colormix_3":"Колормикс (3 цвета)","colormix_fakt":"Фактурный колормикс","stonemix":"Стоунмикс"},"mono_color_groups":{"color1_names":["красный","черный","графит","светло-серый","жёлтый (горчичный)","коричневый","светло-коричневый","терракот"],"color2_names":["белый","желтый-яркий"],"grey_name":["серый","Серые оттенки","Серые_оттенки"]}},
    palettes: {
      stonemix: {"tech":"stonemix","title":"StoneMix","size":[320,320],"format":"webp_lossless_transparentpad","colors":[{"id":"staryy_krym_grafit","name":"Старый Крым графит","file":"technologies/stonemix/colors/staryy_krym_grafit.webp"},{"id":"staryy_krym_cherno_belyy","name":"Старый Крым черно-белый","file":"technologies/stonemix/colors/staryy_krym_cherno_belyy.webp"},{"id":"novyy_svet","name":"Новый свет","file":"technologies/stonemix/colors/novyy_svet.webp"},{"id":"staryy_krym_temnyy","name":"Старый Крым темный","file":"technologies/stonemix/colors/staryy_krym_temnyy.webp"},{"id":"koktebel","name":"Коктебель","file":"technologies/stonemix/colors/koktebel.webp"},{"id":"kara_dag","name":"Кара-Даг","file":"technologies/stonemix/colors/kara_dag.webp"},{"id":"kalamit","name":"Каламит","file":"technologies/stonemix/colors/kalamit.webp"},{"id":"staryy_krym_belyy","name":"Старый Крым белый","file":"technologies/stonemix/colors/staryy_krym_belyy.webp"},{"id":"terrakot","name":"Терракот","file":"technologies/stonemix/colors/terrakot.webp"},{"id":"staryy_krym_chernyy","name":"Старый Крым черный","file":"technologies/stonemix/colors/staryy_krym_chernyy.webp"},{"id":"laspi","name":"Ласпи","file":"technologies/stonemix/colors/laspi.webp"},{"id":"kazantip","name":"Казантип","file":"technologies/stonemix/colors/kazantip.webp"},{"id":"neapol","name":"Неаполь","file":"technologies/stonemix/colors/neapol.webp"}]},
      colormix: {"tech":"colormix","title":"ColorMix","colors":[{"tech":"colormix","index":1,"id":"ai_petri","name":"Ай-Петри","file":"technologies/colormix/colors/ai_petri.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":2,"id":"ayu_dag","name":"Аю-Даг","file":"technologies/colormix/colors/ayu_dag.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":3,"id":"gurzuf","name":"Гурзуф","file":"technologies/colormix/colors/gurzuf.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":4,"id":"zolotye_vorota","name":"Золотые ворота","file":"technologies/colormix/colors/zolotye_vorota.webp","mix_colors":3,"mix_label":"3 цвета"},{"tech":"colormix","index":5,"id":"kara_dag","name":"Кара-Даг","file":"technologies/colormix/colors/kara_dag.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":6,"id":"koktebel","name":"Коктебель","file":"technologies/colormix/colors/koktebel.webp","mix_colors":3,"mix_label":"3 цвета"},{"tech":"colormix","index":7,"id":"neapol","name":"Неаполь","file":"technologies/colormix/colors/neapol.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":8,"id":"novyi_svet","name":"Новый свет","file":"technologies/colormix/colors/novyi_svet.webp","mix_colors":2,"mix_label":"2 цвета"},{"tech":"colormix","index":9,"id":"solnechnaya_dolina","name":"Солнечная долина","file":"technologies/colormix/colors/solnechnaya_dolina.webp","mix_colors":3,"mix_label":"3 цвета"},{"tech":"colormix","index":10,"id":"foros","name":"Форос","file":"technologies/colormix/colors/foros.webp","mix_colors":3,"mix_label":"3 цвета"},{"tech":"colormix","index":11,"id":"hersones","name":"Херсонес","file":"technologies/colormix/colors/hersones.webp","mix_colors":2,"mix_label":"2 цвета"}]},
      mono: {"tech":"mono","title":"Однотонная","count":12,"colors":[{"id":"belyy","index":1,"name":"Белый","file":"technologies/mono/colors/belyy.webp"},{"id":"grafit","index":2,"name":"Графит","file":"technologies/mono/colors/grafit.webp"},{"id":"zheltyy_yarkiy","index":3,"name":"Желтый-яркий","file":"technologies/mono/colors/zheltyy_yarkiy.webp"},{"id":"zheltyy_gorchichnyy","index":4,"name":"Жёлтый (горчичный)","file":"technologies/mono/colors/zheltyy_gorchichnyy.webp"},{"id":"korichnevyy","index":5,"name":"Коричневый","file":"technologies/mono/colors/korichnevyy.webp"},{"id":"krasnyy_yarkiy","index":6,"name":"Красный яркий","file":"technologies/mono/colors/krasnyy_yarkiy.webp"},{"id":"krasnyy","index":7,"name":"Красный","file":"technologies/mono/colors/krasnyy.webp"},{"id":"svetlo_korichnevyy","index":8,"name":"Светло-коричневый","file":"technologies/mono/colors/svetlo_korichnevyy.webp"},{"id":"svetlo_seryy","index":9,"name":"Светло-серый","file":"technologies/mono/colors/svetlo_seryy.webp"},{"id":"serye_ottenki","index":10,"name":"Серые оттенки","file":"technologies/mono/colors/serye_ottenki.webp"},{"id":"terrakot","index":11,"name":"Терракот","file":"technologies/mono/colors/terrakot.webp"},{"id":"chernyy","index":12,"name":"Черный","file":"technologies/mono/colors/chernyy.webp"}]}
    }
  };
  function hasPackagingInPrice(pr){
    try{
      const items = pr?.pavers?.items || [];
      for (const it of items){
        const th = it?.thickness || [];
        for (const t of th){
          if (t?.packaging?.m2_per_pallet || t?.packaging?.pallet_weight_kg) return true;
        }
      }
      return false;
    }catch(e){ return false; }
  }

  const FORM_ID_MAP = {
    antika: 'антика',
    bruschatka: 'брусчатка',
    gazonnaya_reshetka: 'газонная_решетка',
    klassika: 'классика',
    megapolis: 'мегаполис',
    novyy_gorod: 'новый_город',
    paladio: 'палладио',
    poligonal: 'полигональ',
    promenad_i: 'променад_i',
    promenad_ii: 'променад_ii',
    rigel: 'ригель',
    staryy_gorod: 'старый_город'
  };

  const COLORMIX_3 = new Set(['форос','золотые ворота','коктебель','солнечная долина'].map(s=>s.toLowerCase().replace(/ё/g,'е')));

  const elForms   = root.querySelector('[data-role="forms"]');
  const elTechTabs= root.querySelector('[data-role="techTabs"]');
  const elTechHint= root.querySelector('[data-role="techHint"]');
  const elColors  = root.querySelector('[data-role="colors"]');
  const elPicked  = root.querySelector('[data-role="picked"]');
  const elStatus  = root.querySelector('[data-role="status"]');
  const elThTabs  = root.querySelector('[data-role="thicknessTabs"]');
  const elThWrap  = root.querySelector('[data-role="thicknessWrap"]');
  const elQty     = root.querySelector('[data-role="qty"]');

  const elUnit    = root.querySelector('[data-role="unitPrice"]');
  const elTotal   = root.querySelector('[data-role="totalPrice"]');
  const elThLabel = root.querySelector('[data-role="thLabel"]');

  const elM2Pal   = root.querySelector('[data-role="m2Pallet"]');
  const elWPal    = root.querySelector('[data-role="wPallet"]');
  const elPallets = root.querySelector('[data-role="pallets"]');
  const elShipM2  = root.querySelector('[data-role="shipM2"]');
  const elOverM2  = root.querySelector('[data-role="overM2"]');
  const elShipW   = root.querySelector('[data-role="shipW"]');

  const elMoreBtn   = root.querySelector('[data-role="moreBtn"]');
  const elMorePanel = root.querySelector('[data-role="morePanel"]');
  if (elMoreBtn && elMorePanel){
    const chev = elMoreBtn.querySelector('.pcCalc__chev');
    elMoreBtn.addEventListener('click', ()=>{
      const isOpen = !elMorePanel.hasAttribute('hidden');
      if (isOpen){
        elMorePanel.setAttribute('hidden','');
        elMoreBtn.setAttribute('aria-expanded','false');
        if (chev) chev.textContent = '▾';
      }else{
        elMorePanel.removeAttribute('hidden');
        elMoreBtn.setAttribute('aria-expanded','true');
        if (chev) chev.textContent = '▴';
      }
    });
  }

  const state = {
    forms: [],
    price: null,
    palettes: { stonemix:null, colormix:null, mono:null },

    form: null,
    tech: { id:'stonemix', name:'StoneMix' },
    color: null,
    thickness: null
  };

  function status(t){ elStatus.textContent = t || ''; }

  function cleanText(s){
    if (s == null) return '';
    const str = String(s);
    try { return str.normalize('NFC').trim(); } catch(e) { return str.trim(); }
  }

  function normName(s){
    return cleanText(s).toLowerCase().replace(/\s+/g,' ').replace(/ё/g,'е');
  }

  function absUrl(rel){
    if (!rel) return '';
    if (/^https?:\/\//i.test(rel)) return rel;
    return CDN0 + rel.replace(/^\//,'');
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache:'no-store' });
    if (!r.ok) throw new Error(url + ' -> ' + r.status);
    return await r.json();
  }

  function fmtRub(n){
    if (!isFinite(n)) return '—';
    return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 0 }).format(n) + ' ₽';
  }
  function fmtRub2(n){
    if (!isFinite(n)) return '—';
    return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n) + ' ₽';
  }
  function fmtNum(n, digits=2){
    if (!isFinite(n)) return '—';
    return new Intl.NumberFormat('ru-RU', { minimumFractionDigits: digits, maximumFractionDigits: digits }).format(n);
  }

  function toNum(x){
    if (x === null || x === undefined) return 0;
    if (typeof x === 'number') return isFinite(x) ? x : 0;
    // strings like "1 234,56" or "10,2" or "10.2"
    let s = String(x).trim();
    if (!s) return 0;
    s = s.replace(/\s+/g,'');
    s = s.replace(',', '.');
    // keep digits, dot, minus
    s = s.replace(/[^0-9.\-]/g,'');
    const n = Number(s);
    return isFinite(n) ? n : 0;
  }

  function makeCard({ imgSrc, title, active, onClick }){
    const card = document.createElement('div');
    card.className = 'paverConf2026__card' + (active ? ' is-active' : '');

    const imgWrap = document.createElement('div');
    imgWrap.className = 'paverConf2026__img';
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.alt = title;
    img.src = imgSrc;
    imgWrap.appendChild(img);

    const name = document.createElement('div');
    name.className = 'paverConf2026__name';
    name.textContent = title;

    card.appendChild(imgWrap);
    card.appendChild(name);
    card.addEventListener('click', onClick);
    return card;
  }

  function renderPicked(){
    const f  = state.form ? cleanText(state.form.name || state.form.id) : '—';
    const t  = state.tech ? cleanText(state.tech.name) : '—';
    const c  = state.color ? cleanText(state.color.name || state.color.id) : '—';
    const th = state.thickness ? (state.thickness + ' мм') : '—';
    elPicked.innerHTML = `<b>Вы выбрали:</b> ${f} · ${t} · ${c} · ${th}`;
  }

  function renderForms(){
    elForms.innerHTML = '';
    state.forms.forEach(f=>{
      const title = cleanText(f.name || f.id);
      const imgSrc = absUrl(f.preview || f.image || '');
      elForms.appendChild(makeCard({
        imgSrc,
        title,
        active: state.form && state.form.id === f.id,
        onClick: ()=>{
          state.form = f;
          state.thickness = null;
          renderForms();
          renderThickness();
          renderPicked();
          compute();
        }
      }));
    });
  }

  function renderTechTabs(){
    const items = [
      { id:'stonemix', name:'StoneMix',   hint:'Цена из колонки «Стоунмикс».' },
      { id:'colormix', name:'ColorMix',   hint:'Внутри палитры есть «2 цвета» и «3 цвета». Колонка прайса выбирается автоматически.' },
      { id:'mono',     name:'Однотонная', hint:'' },
    ];

    elTechTabs.innerHTML = '';
    items.forEach(t=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'paverConf2026__tab' + (state.tech?.id === t.id ? ' is-active' : '');
      b.textContent = t.name;
      b.addEventListener('click', async ()=>{
        state.tech = { id:t.id, name:t.name };
        state.color = null;

        await ensurePaletteLoaded();
        state.color = firstColorForTech();

        renderTechTabs();
        renderColors();
        renderPicked();
        compute();
      });
      elTechTabs.appendChild(b);
    });

    const active = items.find(x=>x.id === state.tech?.id);
    elTechHint.textContent = active ? active.hint : '';
  }

  function paletteKeyForTech(){
    if (state.tech?.id === 'stonemix') return 'stonemix';
    if (state.tech?.id === 'mono') return 'mono';
    return 'colormix';
  }

  async function ensurePaletteLoaded(){
    const key = paletteKeyForTech();
    if (state.palettes[key]) return;

    const url = absUrl(PALS[key]) + '?cb=' + Date.now();
    const raw = await fetchJson(url);
    const colors = Array.isArray(raw) ? raw : (raw?.colors || []);
    state.palettes[key] = colors.map((c, idx)=>({
      id: c.id || String(idx+1),
      name: cleanText(c.name || ''),
      file: c.file || c.img || c.preview || '',
      mix_colors: Number(c.mix_colors ?? c.mixColors ?? 0) || null
    }));
  }

  function firstColorForTech(){
    const key = paletteKeyForTech();
    const arr = state.palettes[key] || [];
    return arr[0] || null;
  }

  function renderColors(){
    elColors.innerHTML = '';
    const key = paletteKeyForTech();
    const items = state.palettes[key] || [];

    if (!items.length){
      elColors.textContent = 'Цвета не найдены.';
      return;
    }

    items.forEach(c=>{
      let title = cleanText(c.name || c.id);
      if (state.tech?.id === 'colormix') {
        const cname = normName(title);
        const tag = (Number(c.mix_colors) === 3 || COLORMIX_3.has(cname)) ? '3 цвета' : '2 цвета';
        title = `${title} · ${tag}`;
      }
      const imgSrc = absUrl(c.file);
      elColors.appendChild(makeCard({
        imgSrc,
        title,
        active: state.color && state.color.id === c.id,
        onClick: ()=>{
          state.color = c;
          renderColors();
          renderPicked();
          compute();
        }
      }));
    });
  }

  function getPricePaverItemByForm(form){
    const items = state.price?.pavers?.items || [];
    if (!form || !items.length) return null;

    const mappedId = FORM_ID_MAP[form.id];
    if (mappedId){
      const byMapped = items.find(x => x.id === mappedId);
      if (byMapped) return byMapped;
    }
    const byId = items.find(x => x.id === form.id);
    if (byId) return byId;

    const fn = normName(form.name || '');
    const byName = items.find(x => normName(x.name || '') === fn);
    if (byName) return byName;

    return null;
  }

  function thicknessOptionsForForm(form){
    const it = getPricePaverItemByForm(form);
    if (!it) return [];
    return (it.thickness || []).map(t => t.mm);
  }

  function thicknessObjFor(form, thicknessMm){
    const it = getPricePaverItemByForm(form);
    if (!it) return null;
    return (it.thickness || []).find(t => String(t.mm) === String(thicknessMm)) || null;
  }

  function pickMonoColumnByColorName(colorName){
    const groups = state.price?.mono_color_groups;
    const n = normName(colorName);

    const inList = (arr) => (arr || []).some(x => normName(x) === n);

    if (groups){
      if (inList(groups.grey_name)) return 'grey';
      if (inList(groups.color2_names)) return 'mono_color2';
      if (inList(groups.color1_names)) return 'mono_color1';
    }
    return 'mono_color1';
  }

  function columnForPricing(){
    const id = state.tech?.id;
    if (id === 'stonemix')  return 'stonemix';
    if (id === 'mono')      return pickMonoColumnByColorName(state.color?.name || '');
    if (id === 'colormix'){
      const mc = Number(state.color?.mix_colors || 0);
      if (mc) return mc === 3 ? 'colormix_3' : 'colormix_2';
      const cname = normName(state.color?.name || '');
      return COLORMIX_3.has(cname) ? 'colormix_3' : 'colormix_2';
    }
    return null;
  }

  function renderThickness(){
    elThTabs.innerHTML = '';
    const opts = thicknessOptionsForForm(state.form);

    // Требование: показываем блок толщины всегда, даже если вариант один
    if (elThWrap) elThWrap.dataset.hidden = (opts.length ? '0' : '1');

    if (!opts.length){
      elThTabs.textContent = 'Нет данных по толщине.';
      state.thickness = null;
      return;
    }

    // Если толщина одна — показываем кнопку, делаем активной и disabled
    if (opts.length === 1){
      state.thickness = opts[0];

      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'paverConf2026__tab is-active';
      b.textContent = opts[0] + ' мм';
      b.disabled = true;
      elThTabs.appendChild(b);

      renderPicked();
      compute();
      return;
    }

    if (!state.thickness) state.thickness = opts[0];

    opts.forEach(mm=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'paverConf2026__tab' + (String(state.thickness) === String(mm) ? ' is-active' : '');
      b.textContent = mm + ' мм';
      b.addEventListener('click', ()=>{
        state.thickness = mm;
        renderThickness();
        renderPicked();
        compute();
      });
      elThTabs.appendChild(b);
    });
  }

  function setCalcDashes(){
    elUnit.textContent = '—';
    elTotal.textContent = '—';
    elThLabel.textContent = '—';
    elM2Pal.textContent = '—';
    elWPal.textContent = '—';
    elPallets.textContent = '—';
    elShipM2.textContent = '—';
    elOverM2.textContent = '—';
    elShipW.textContent = '—';
  }

  function compute(){
    if (!state.form || !state.tech || !state.thickness){
      setCalcDashes();
      return;
    }

    const thObj = thicknessObjFor(state.form, state.thickness);
    const prices = thObj ? thObj.prices : null;
    const col = columnForPricing();
    if (!prices || !col){
      setCalcDashes();
      return;
    }

    const v = prices[col];

    const pack = thObj?.packaging || null;
    const m2PerPallet = toNum(pack?.m2_per_pallet);
    const wPerPallet  = toNum(pack?.pallet_weight_kg);

    elThLabel.textContent = state.thickness ? (state.thickness + ' мм') : '—';
    elM2Pal.textContent   = m2PerPallet ? (fmtNum(m2PerPallet, 2) + ' м²') : '—';
    elWPal.textContent    = wPerPallet ? (Math.round(wPerPallet) + ' кг') : '—';

    const area = Math.max(0, toNum(elQty.value || 0));

    let unit = null;
    if (typeof v === 'string'){
      const s = normName(v);
      if (s.includes('по запросу')){
        elUnit.textContent = 'по запросу';
        elTotal.textContent = 'по запросу';

        if (m2PerPallet){
          const pallets = Math.max(1, Math.ceil(area / m2PerPallet));
          const shipM2 = pallets * m2PerPallet;
          const overM2 = shipM2 - area;
          elPallets.textContent = String(pallets);
          elShipM2.textContent = fmtNum(shipM2, 2) + ' м²';
          elOverM2.textContent = fmtNum(overM2, 2) + ' м²';
          elShipW.textContent = wPerPallet ? (Math.round(pallets * wPerPallet) + ' кг') : '—';
        } else {
          elPallets.textContent = '—';
          elShipM2.textContent = '—';
          elOverM2.textContent = '—';
          elShipW.textContent = '—';
        }
        return;
      }

      if (s === '-' || s === '—' || s === ''){
        setCalcDashes();
        return;
      }

      const num = toNum(v);
      if (!isFinite(num)){
        elUnit.textContent = v;
        elTotal.textContent = '—';
        return;
      }
      unit = num;
    } else {
      const num = toNum(v);
      if (!isFinite(num)){
        setCalcDashes();
        return;
      }
      unit = num;
    }

    elUnit.textContent = fmtRub2(unit) + ' / м²';

    if (m2PerPallet){
      const pallets = Math.max(1, Math.ceil(area / m2PerPallet));
      const shipM2  = pallets * m2PerPallet;
      const overM2  = shipM2 - area;

      elPallets.textContent = String(pallets);
      elShipM2.textContent  = fmtNum(shipM2, 2) + ' м²';
      elOverM2.textContent  = fmtNum(overM2, 2) + ' м²';
      elShipW.textContent   = wPerPallet ? (Math.round(pallets * wPerPallet) + ' кг') : '—';

      elTotal.textContent = fmtRub(unit * shipM2);
      return;
    }

    elPallets.textContent = '—';
    elShipM2.textContent = '—';
    elOverM2.textContent = '—';
    elShipW.textContent = '—';
    elTotal.textContent = fmtRub(unit * area);
  }

  try{
    status('Загрузка данных…');

    let forms = null, price = null;

    // Try CDN first
    try{
      [forms, price] = await Promise.all([
        fetchJson(absUrl(FORMS_JSON) + '?cb=' + Date.now()),
        fetchJson(absUrl(PRICE_JSON) + '?cb=' + Date.now())
      ]);
    }catch(err){
      console.warn('CDN fetch failed, using INLINE_DATA fallback', err);
      forms = INLINE_DATA.forms;
      price = INLINE_DATA.price;
    }

    // If CDN returned a price without packaging (cached/old), override with inline (packaging-aware) version
    if (!hasPackagingInPrice(price) && hasPackagingInPrice(INLINE_DATA.price)){
      console.warn('CDN price_catalog.json has no packaging; overriding with inline price (contains packaging).');
      price = INLINE_DATA.price;
    }

    state.forms = Array.isArray(forms) ? forms : INLINE_DATA.forms;
    state.price = price || INLINE_DATA.price;

    state.form = state.forms[0] || null;

    await ensurePaletteLoaded();
    state.color = firstColorForTech();

    renderForms();
    renderTechTabs();
    renderColors();
    renderThickness();
    renderPicked();
    compute();

    status('Ок. Данные загружены.');
  } catch (e){
    console.error(e);
    status('Ошибка загрузки данных. Проверьте Console (F12). Если price_catalog.json не грузится с CDN — используется встроенный прайс; убедитесь, что изображения доступны по data-cdn.');
  }

  elQty.addEventListener('input', compute);
})();
</script>
